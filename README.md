# qr-generator

Cloudflare Worker that generates ultra-lightweight B/W QR codes as optimized SVG with edge caching.

<img src="demo.svg" width="200" height="200" alt="QR code linking to this repo — generated by this project">

**80 KB** (QR Monkey) → **5 KB** (this) for the same URL. Single `<path>` with run-length encoding, integer coordinates, no masks/clipPaths/floats.

## Usage examples

After deploying, your worker is available at `https://qr-generator.<your-account>.workers.dev`.

```bash
# Basic — default preset (250px), ecc=M, quiet=2
/qr.inline?data=https://example.com

# Small preset (125px)
/qr.inline?data=https://example.com&p=sq125

# High error correction
/qr.inline?data=https://example.com&ecc=H

# No quiet zone
/qr.inline?data=https://example.com&q=0

# Canonical with edge cache (302 redirect)
/qr.svg?data=https://example.com&p=sq300&ecc=Q
```

## Endpoints

### `GET /qr.svg` — redirect to canonical (for caching)

| Param | Required | Default | Description |
|-------|----------|---------|-------------|
| `data` | yes | — | URL or string to encode |
| `p` | no | `sq250` | Preset: `sq125`, `sq200`, `sq250`, `sq300` |
| `ecc` | no | `M` | Error correction: `L`, `M`, `Q`, `H` |
| `q` | no | `2` | Quiet zone in modules (0–16) |

Returns **302** → `/qr/<preset>/<sha256>.svg` with params in query for cold-cache regeneration.

### `GET /qr.inline` — direct SVG response (for embedding)

Same params as above. Returns **200** with `image/svg+xml` — no redirect, ideal for Webstudio inline embedding or copy-paste.

Edge-cached by full URL (24h TTL). Same URL = instant response from cache on subsequent requests. `X-QR-Cache: HIT|MISS` header for diagnostics.

### `GET /qr/<preset>/<hash>.svg` — canonical (edge-cached)

Serves SVG from Cloudflare edge cache. Cache key is pathname only (no query).
- **HIT** → instant response, `X-QR-Cache: HIT`
- **MISS** → generates SVG, caches in background, `X-QR-Cache: MISS`
- **MISS without query params** → `400` with instructions

Headers on canonical response:
```
Content-Type: image/svg+xml; charset=utf-8
Cache-Control: public, max-age=31536000, immutable
ETag: "<hash>"
X-QR-Cache: HIT|MISS
```

## SVG output

- Single-line, no formatting
- `shape-rendering="crispEdges"`
- One `<rect>` (white background) + one `<path>` (black modules)
- Horizontal run-length encoding: `M{x} {y}h{w}v1h-{w}z`
- All coordinates are integers
- No `mask`, `clipPath`, `<g>`, or float values
- `viewBox` in module units, `width`/`height` from preset in px

## Development

```bash
npm install
npm run dev          # wrangler dev
npm test             # vitest
npm run typecheck    # tsc --noEmit
```

## Deploy

### Quick setup (manual)

1. [Sign up](https://dash.cloudflare.com/sign-up) for a free Cloudflare account
2. Install [Node.js](https://nodejs.org/) 18+
3. Clone and install:
   ```bash
   git clone https://github.com/investblog/qr-generator.git
   cd qr-generator
   npm install
   ```
4. Login to Cloudflare:
   ```bash
   npx wrangler login
   ```
5. Deploy:
   ```bash
   npx wrangler deploy
   ```
6. Your worker URL will be printed: `https://qr-generator.<your-account>.workers.dev`

### CI/CD (GitHub Actions)

Automatic deploy on push to `main`. Add two repo secrets (`Settings → Secrets and variables → Actions`):

**`CLOUDFLARE_ACCOUNT_ID`** — found in [Cloudflare Dashboard](https://dash.cloudflare.com/) → Workers & Pages → right sidebar

**`CLOUDFLARE_API_TOKEN`** — create at [Cloudflare Dashboard](https://dash.cloudflare.com/profile/api-tokens):
1. Click **Create Token**
2. Find **"Edit Cloudflare Workers"** template → **Use template**
3. Account Resources → your account
4. Zone Resources → All zones
5. **Continue to summary** → **Create Token**
6. Copy the token (shown once)

## API key (optional)

By default the worker is open (no auth). To restrict access, set `API_KEY` in `wrangler.toml` or in Cloudflare Dashboard → Workers → Settings → Variables:

```toml
[vars]
API_KEY = "your-secret-key"
```

When set, every request must include the header, otherwise the worker returns `401 Unauthorized`. Leave empty to keep open access.

```bash
curl -H "X-API-Key: your-secret-key" "https://<your-worker>.workers.dev/qr.inline?data=https://example.com"
```

## [Webstudio](https://webstudio.is) integration

### Static QR code

1. Open your project in [Webstudio](https://webstudio.is)
2. In the left panel, go to **Variables** → click **+** → **New Resource**
3. Name it (e.g. `_qr`)
4. Method: **Get**
5. URL: `https://<your-worker>.workers.dev/qr.inline`
6. Click **+** under **Search Params**, add:
   - Name: `data`, Value: the URL you want to encode (e.g. `https://example.com`)
7. If API key is enabled — click **+** under **Headers**, add:
   - Name: `X-API-Key`, Value: your secret key
8. Use the resource in an HTML Embed or Image component — bind `src` to the resource URL or use the response body as inline SVG

### Dynamic QR code (unique per page)

To generate a different QR code for each page (e.g. based on a URL slug):

1. Create the Resource as above
2. In the `data` search param, switch to **Expression** mode
3. Use an expression like:
   ```
   "https://your-domain.com/go/" + system.params.slug
   ```
4. Each page with a different slug will get its own QR code, edge-cached automatically

### Customization params

Add more search params to customize the output:

| Param | Example | Description |
|-------|---------|-------------|
| `p` | `sq125` | Size preset: `sq125`, `sq200`, `sq250` (default), `sq300` |
| `ecc` | `H` | Error correction: `L`, `M` (default), `Q`, `H` |
| `q` | `0` | Quiet zone in modules: 0–16 (default 2) |

## Tech

- **Runtime**: Cloudflare Workers
- **QR library**: [uqr](https://github.com/unjs/uqr) (zero deps, pure ESM)
- **Tests**: Vitest (37 tests — params, hash, render, golden snapshots)
- **Hash**: SHA-256 via Web Crypto API
