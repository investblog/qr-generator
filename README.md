# qr-generator

Cloudflare Worker that generates ultra-lightweight B/W QR codes as optimized SVG with edge caching.

<a href="https://qr-generator.cryptocasino.workers.dev/qr.inline?data=https://github.com/investblog/qr-generator&p=sq200"><img src="https://qr-generator.cryptocasino.workers.dev/qr.inline?data=https://github.com/investblog/qr-generator&p=sq200" width="200" height="200" alt="QR code linking to this repo — generated by this project"></a>

**80 KB** (QR Monkey) → **5 KB** (this) for the same URL. Single `<path>` with run-length encoding, integer coordinates, no masks/clipPaths/floats.

## Endpoints

### `GET /qr.svg` — redirect to canonical (for caching)

| Param | Required | Default | Description |
|-------|----------|---------|-------------|
| `data` | yes | — | URL or string to encode |
| `p` | no | `sq250` | Preset: `sq125`, `sq200`, `sq250`, `sq300` |
| `ecc` | no | `M` | Error correction: `L`, `M`, `Q`, `H` |
| `q` | no | `2` | Quiet zone in modules (0–16) |

Returns **302** → `/qr/<preset>/<sha256>.svg` with params in query for cold-cache regeneration.

### `GET /qr.inline` — direct SVG response (for embedding)

Same params as above. Returns **200** with `image/svg+xml` — no redirect, ideal for Webstudio inline embedding or copy-paste.

Edge-cached by full URL (24h TTL). Same URL = instant response from cache on subsequent requests. `X-QR-Cache: HIT|MISS` header for diagnostics.

### `GET /qr/<preset>/<hash>.svg` — canonical (edge-cached)

Serves SVG from Cloudflare edge cache. Cache key is pathname only (no query).
- **HIT** → instant response, `X-QR-Cache: HIT`
- **MISS** → generates SVG, caches in background, `X-QR-Cache: MISS`
- **MISS without query params** → `400` with instructions

Headers on canonical response:
```
Content-Type: image/svg+xml; charset=utf-8
Cache-Control: public, max-age=31536000, immutable
ETag: "<hash>"
X-QR-Cache: HIT|MISS
```

## SVG output

- Single-line, no formatting
- `shape-rendering="crispEdges"`
- One `<rect>` (white background) + one `<path>` (black modules)
- Horizontal run-length encoding: `M{x} {y}h{w}v1h-{w}z`
- All coordinates are integers
- No `mask`, `clipPath`, `<g>`, or float values
- `viewBox` in module units, `width`/`height` from preset in px

## Development

```bash
npm install
npm run dev          # wrangler dev
npm test             # vitest
npm run typecheck    # tsc --noEmit
```

## Deploy

### Quick setup (manual)

1. [Sign up](https://dash.cloudflare.com/sign-up) for a free Cloudflare account
2. Install [Node.js](https://nodejs.org/) 18+
3. Clone and install:
   ```bash
   git clone https://github.com/investblog/qr-generator.git
   cd qr-generator
   npm install
   ```
4. Login to Cloudflare:
   ```bash
   npx wrangler login
   ```
5. Deploy:
   ```bash
   npx wrangler deploy
   ```
6. Your worker URL will be printed: `https://qr-generator.<your-account>.workers.dev`

### CI/CD (GitHub Actions)

Automatic deploy on push to `main`. Add repo secrets:
- `CLOUDFLARE_API_TOKEN` — create at [Cloudflare Dashboard](https://dash.cloudflare.com/profile/api-tokens) → "Edit Cloudflare Workers" template
- `CLOUDFLARE_ACCOUNT_ID` — found in Workers & Pages → Overview (right sidebar)

## Webstudio integration

1. Create a **Resource** variable (e.g. `_qr`)
2. Method: **Get**
3. URL: `https://<your-worker>.workers.dev/qr.inline`
4. Search Params: `data` = your target URL

For dynamic QR codes per page, use an expression in the `data` param — concatenate your base URL with `system.params.slug` or any other variable.

## Tech

- **Runtime**: Cloudflare Workers
- **QR library**: [uqr](https://github.com/unjs/uqr) (zero deps, pure ESM)
- **Tests**: Vitest (37 tests — params, hash, render, golden snapshots)
- **Hash**: SHA-256 via Web Crypto API
