## Финальное ТЗ: Cloudflare Worker для генерации ультра-лёгких QR (SVG, B/W, presets)

### 0) Контекст

Нужен Worker, который генерирует QR-коды из URL/строк и отдаёт **минимально возможный по весу SVG**, пригодный для быстрых сайтов и массового использования через edge-кэш. В MVP — **только ч/б**, без логотипов, без кастомных стилей, без “QR-Monkey-подобных” масок/групп и дробных координат. Размеры выдачи **шаблонизированы пресетами** (квадраты).

---

# 1) Цели и KPI

### 1.1 Цели

* Генерировать QR (byte-mode) и отдавать **оптимизированный SVG**.
* Обеспечить высокий cache hit rate за счёт канонических URL.
* Дать пресеты размеров (квадратные) для удобного использования в Webstudio и дальнейшего API.

### 1.2 KPI (ориентиры)

* SVG не содержит `mask`, `clipPath`, вложенных `<g>` и дробных координат.
* SVG содержит один `<path>` для модулей, координаты — целые.
* На cache HIT: минимальный TTFB (edge cache).
* На cache MISS: генерация + рендер занимают “мало” (практически мгновенно в рамках Worker).

---

# 2) Поддерживаемые возможности

### 2.1 Входные данные

* `data` — строка (обычно URL), кодируется как query или JSON (см. API).
* Поддерживаем только byte-mode (достаточно для URL), ECC: `L|M|Q|H`.

### 2.2 Выход

* `image/svg+xml` (UTF-8), детерминированный, кэшируемый.

### 2.3 Стиль

* Только чёрный (`#000`) по белому (`#fff`).
* Quiet zone по умолчанию — `4` модуля (настраиваемо параметром в пределах заданного диапазона).

---

# 3) Пресеты размеров (квадраты)

### 3.1 Preset IDs

Worker обязан поддерживать фиксированный список пресетов:

* `sq125` → 125×125 px
* `sq200` → 200×200 px
* `sq250` → 250×250 px (default)
* `sq300` → 300×300 px

### 3.2 Поведение

* Если `p` не указан → используется `sq250`.
* Любые значения вне whitelist → `400 Bad Request`.

---

# 4) API

## 4.1 Удобный endpoint (для клиентов)

**GET `/qr.svg`**

Query параметры:

* `data` (required)
* `p` (optional) — preset id (default `sq250`)
* `ecc` (optional) — `L|M|Q|H` (default `M`)
* `q` (optional) — quiet zone в модулях (default `4`, диапазон 0..16)

Поведение:

* Worker нормализует вход (см. 4.3), вычисляет `hash` (см. 4.4) и делает **302 redirect** на канонический URL:

  * `/qr/<p>/<hash>.svg`

Назначение:

* максимальный hit-rate кэша (по path), не зависящий от порядка query/лишних пробелов.

## 4.2 Канонический endpoint (кэш-ключ)

**GET `/qr/<p>/<hash>.svg`**

Поведение:

* Отдаёт SVG для соответствующей комбинации параметров.
* Результат **строго детерминирован**.

## 4.3 Нормализация входа (MUST)

Перед вычислением хэша:

* `data` MUST быть `trim()` (удаление пробелов по краям).
* Максимальная длина `data` MUST быть ограничена (default: 2048 символов).
* `ecc`, `q`, `p` MUST быть приведены к каноническому виду (uppercase для ecc, integer для q).
* Любые невалидные параметры → `400`.

*(Автодобавление `https://` к URL без схемы — НЕ делаем в MVP, чтобы не менять смысл входа. Можно добавить позже как опцию.)*

## 4.4 Хэширование (MUST)

`hash` = `hex(sha256(payload))`, где `payload` — строка:

```
data + "|" + "p=" + p + "|ecc=" + ecc + "|q=" + q + "|fg=000|bg=fff|r=v1"
```

* Алгоритм MUST быть SHA-256.
* Hex lowercase.
* `r=v1` — версия рендера/формата на будущее (чтобы можно было обновлять рендер не ломая старые URL при необходимости).

---

# 5) Кэширование и заголовки

## 5.1 Edge cache (MUST)

Для `/qr/<p>/<hash>.svg` Worker MUST:

1. Проверять `caches.default.match(request)`
2. Если HIT → вернуть cached response
3. Если MISS → сгенерировать SVG, вернуть response и положить в cache через `ctx.waitUntil(caches.default.put(...))`

## 5.2 Заголовки (MUST)

Для канонического SVG:

* `Content-Type: image/svg+xml; charset=utf-8`
* `Cache-Control: public, max-age=31536000, immutable`
* `ETag: "<hash>"` (SHOULD)

Для редиректа `/qr.svg?...`:

* `Cache-Control: public, max-age=3600`

## 5.3 Диагностика (SHOULD)

* `X-QR-Cache: HIT|MISS` (для отладки и наблюдаемости).

---

# 6) Генерация QR (матрица)

## 6.1 Требования к библиотеке (MUST)

Выбранная QR-библиотека MUST:

* работать в Cloudflare Workers (без Node-API/Canvas/DOM),
* позволять получить матрицу модулей (`boolean[][]` или `isDark(x,y)`),
* поддерживать ECC `L|M|Q|H`,
* быть минимальной по размеру.

## 6.2 Режим кодирования

* Основной режим: byte.
* Уровень коррекции по умолчанию: `M`.

---

# 7) Рендер SVG (ультра-лёгкий)

## 7.1 Общие требования (MUST)

SVG MUST:

* быть однострочным (без форматирования/переносов/отступов),
* содержать `shape-rendering="crispEdges"`,
* использовать `viewBox="0 0 dim dim"`, где:

  * `dim = modules + 2*q`
  * `modules = matrix.length`

SVG MUST содержать:

* ровно один белый фон:

  * `<rect width="{dim}" height="{dim}" fill="#fff"/>`
* ровно один чёрный path для всех модулей:

  * `<path fill="#000" d="..."/>`

## 7.2 Запрещённые конструкции (MUST NOT)

SVG MUST NOT содержать:

* `mask`, `clipPath`, `<g>` для структуры,
* дробные координаты (float),
* отдельные элементы на каждый модуль (`<rect>` per module).

## 7.3 Координатная система (MUST)

* Рендер ведётся в координатах “по модулям”: 1 unit = 1 QR module.
* Все координаты и длины MUST быть целыми числами.

## 7.4 Оптимизация модулей (MUST)

Модули MUST рендериться через **горизонтальные пробеги (run-length)**:

* Для каждой строки `y` матрицы:

  * находить последовательности чёрных модулей `[x..x2)`
  * добавлять в `d` одну команду прямоугольника высотой 1 модуль.

Команда MUST использовать компактный прямоугольник вида:

* `M sx sy h w v 1 h -w z`
  где:
* `sx = x + q`
* `sy = y + q`
* `w = x2 - x`

## 7.5 Пиксельный размер (MUST)

* В SVG MUST быть выставлены `width` и `height` согласно выбранному preset.
* `viewBox` остаётся модульным (см. 7.1).

---

# 8) Валидация и ошибки

## 8.1 Ограничения (MUST)

* `data` обязательный параметр.
* `len(data) <= 2048` (configurable).
* `q` MUST быть целым числом в диапазоне 0..16.
* `ecc` MUST быть одним из `L|M|Q|H`.
* `p` MUST быть из whitelist.

## 8.2 Коды ответов

* `400 Bad Request` — отсутствует `data` / неверные параметры.
* `413 Payload Too Large` — превышен лимит длины `data`.
* `404 Not Found` — неизвестный маршрут.
* `500 Internal Server Error` — ошибка генерации/рендера.

---

# 9) Наблюдаемость и эксплуатация

## 9.1 Логи (SHOULD)

* Логировать только MISS и только при включённом флаге ENV (`LOG_MISS=true`), чтобы не засорять логи.

## 9.2 Конфигурация (SHOULD)

ENV переменные:

* `DEFAULT_PRESET` (sq250)
* `DEFAULT_ECC` (M)
* `DEFAULT_QUIET` (4)
* `MAX_DATA_LEN` (2048)
* `LOG_MISS` (false)

---

# 10) Тестирование и приёмка

## 10.1 Автотесты (MUST)

* Канонизация: одинаковые входы → одинаковый hash и редирект.
* Рендер: SVG

  * содержит `crispEdges`,
  * содержит один `<rect>` и один `<path>`,
  * не содержит `mask/clipPath/<g>`,
  * не содержит `.` (точку) в координатах (то есть нет float),
  * однострочный.
* Валидаторы параметров: диапазоны, whitelist.

## 10.2 Интеграционная приёмка (MUST)

* Сканирование реальными сканерами (iOS/Android) для:

  * `sq125`, `sq200`, `sq250` при `ecc=M`,
  * минимум один кейс на `ecc=Q`,
  * разные длины URL.
    Критерий: уверенное сканирование при дефолтном quiet=4.

---

# 11) Решения “на будущее” (не в MVP, но заложено)

* POST `/qr` для прогрева кэша/серверного использования.
* Нештатные форматы (не квадраты) — добавляются флагом и отдельным whitelist.
* Версионирование рендера через `r=v1` в хэш-payload.
